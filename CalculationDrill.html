<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!--<script type="text/javasccript" src="FormScripts.js"></script>-->
    <script>
        function formActive (check, form) {
            let tgt = form;
            let checker = check;
            if(checker.checked === false) tgt.disabled = "disabled";
            else tgt.disabled = null;
        }
        function formInactive (check, form) {
            let tgt = form;
            let checker = check;
            if(checker.checked === false) tgt.disabled = null;
            else tgt.disabled = "disabled";
        }
        function formDisplay (check, form) {
            let tgt = form;
            let checker = check;
            if(checker.checked === false) tgt.style.display = "none";
            else tgt.style.display = "block";
        }
        function formHide (check, form) {
            let tgt = form;
            let checker = check;
            if(checker.checked === false) tgt.style.display = "block";
            else tgt.style.display = "none";
        }
    </script>
    <script>
        function checkSetting (questionNumber, digitMin, digitMax, limitTime) {
            errorMessageReset ();
            isInputError = false;
            if(!questionNumber) isInputError = inputError (document.getElementById("numberOfQuestionsNull"));
            if(questionNumber > 100) isInputError = inputError (document.getElementById("numberOfQuestionsIllegal"));
            if(!digitMin) isInputError = inputError (document.getElementById("minimumDigitsNull"));
            if(digitMin < 1) isInputError = inputError (document.getElementById("minimumDigitsIllegal"));
            if(digitMin > digitMax) isInputError = inputError (document.getElementById("minimumDigitsCompare"));
            if(!digitMax) isInputError = inputError (document.getElementById("maxDigitsNull"));
            if(digitMax > 4) isInputError = inputError (document.getElementById("maxDigitsIllegal"));
            if(digitMin > digitMax) isInputError = inputError (document.getElementById("minimumDigitsCompare"));
            if(document.getElementById("timeLimitSetting").checked && !limitTime) isInputError = inputError (document.getElementById("timeLimitNull"));
            if(isInputError) return;
            else{
                createDrill (questionNumber, digitMin, digitMax, limitTime);
                drillStart ();
            }
        }
        function createDrill (questionNumber, digitMin, digitMax, limitTime) {
            const parentList = document.getElementById("drillEntity");
            const prefix = "    ";
            if(parentList.getElementsByTagName("li").length > 0) parentList.innerHTML = "";
            let min = digitMin === 1 ? 0 : Math.pow(10, digitMin - 1);
            let max = Math.pow(10, digitMax) - 1;
            let arithmeticOperations = document.getElementById("useOperations").value.split(",");
            for(let i=0; i<questionNumber; i++){
                let leftSide = Math.floor(Math.random() * (max - min) + min);
                let leftSideString = (prefix + leftSide.toString(10)).slice(-4);
                let operationNum = Math.floor(Math.random() * arithmeticOperations.length);
                let questionOperation = arithmeticOperations[operationNum];
                let rightSide = Math.floor(Math.random() * (max - min) + min);
                let rightSideString = (prefix + rightSide.toString(10)).slice(-4);
                let answerValue = makeAnswer (leftSide, rightSide, operationNum);
                let questionlist = document.createElement("li");
                let questionEntity = document.createElement("span");
                let answerForm = document.createElement("input");
                answerForm.type = "number";
                answerForm.name = "answerForm";
                answerForm.className = "answerForm";
                let answerDisplay = document.createElement("input");
                answerDisplay.type = "number";
                answerDisplay.name = "answerDisplay";
                answerDisplay.className = "answerDisplay";
                questionEntity.innerText = leftSideString + " " + questionOperation + " " + rightSideString + " = ";
                answerDisplay.value = answerValue;
                questionlist.appendChild(questionEntity);
                questionlist.appendChild(answerForm);
                questionlist.appendChild(answerDisplay);
                parentList.appendChild(questionlist);
                document.getElementById("timeLimitCount").innerText = limitTime;
            }
            document.getElementById("questionCreateButton").disabled = "disabled";
            document.getElementById("endButton").style.display = "block";
        }

        function makeAnswer (left, right, operation) {
            let ans = 0;
            switch (operation) {
                case 0:
                  ans = left + right;
                  break;
                case 1:
                  ans = left - right;
                  break;
                case 2:
                  ans = left * right;
                  break;
                case 3:
                  ans = left / right;
                  break;
                default:
                  break;
            }
            return ans;
        }

        function inputError (errMessage) {
            errMessage.style.display = "block";
            return true;
        }

        function errorMessageReset () {
            const errors = document.getElementsByClassName("errorMessage");
            const errorNum = errors.length;
            for (let j=0;j<errorNum;j++) {
                errors[j].style.display = "";
            }
        }

        function drillProgress (target, isEnd) {
            const curtain = target;
            const precount = parseInt(curtain.innerText);
            if(!precount) return;
            curtain.style.display = "block";
            let currentCount = precount;
            let timer = setInterval( function () {
                if(window.isInputError){
                    curtain.innerText = precount.toString();
                    curtain.style.display = "none";
                    return;
                }
                currentCount--;
                curtain.innerText = currentCount.toString();
                if(currentCount <= 0){
                    clearInterval(timer);
                    curtain.innerText = precount.toString();
                    curtain.style.display = "none";
                    if(isEnd) drillEnd();
                }else if(isEnd && document.getElementById("drillEntity").getElementsByTagName("li")[0].getElementsByTagName("span").length > 1){
                    clearInterval(timer);
                    target.style.display = "none";
                }
            }, 1000);
        }

        function drillStart () {
            drillProgress(document.getElementById("countDown"), false);
            let observer = new MutationObserver ( function (mutations) {
                if(document.getElementById("countDown").style.display === "none"){
                    document.getElementById("timeLimitDisplay").style.display = "block";
                    observer.disconnect();
                    drillProgress(document.getElementById("timeLimitCount"), true);
                }
            });
            observer.observe( document.getElementById("countDown"), {
                attributes: true  
            })
        }

        function drillEnd () {
            document.getElementById("endButton").disabled = "disabled";
            document.getElementById("questionCreateButton").disabled = "disabled";
            let finishDisplay = document.getElementById("countDown");
            finishDisplay.style.display = "block";
            finishDisplay.innerText = "Finish!";
            setTimeout( function (){
                document.getElementById("timeLimitDisplay").style.display = "none";
                finishDisplay.style.display = "none";
                const questions = document.getElementById("drillEntity");
                const questionSub = questions.getElementsByTagName("li");
                const questionNumber = questionSub.length;
                let h = 0;
                let answered = setInterval( function () {
                    if(h < questionNumber){
                        let myAnswer = questionSub[h].getElementsByClassName("answerForm")[0];
                        let correctAnswer = questionSub[h].getElementsByClassName("answerDisplay")[0];
                        correctAnswer.style.display = "inline-block";
                        if(myAnswer.value === correctAnswer.value){
                            let ok = document.createElement("span");
                            ok.innerText = "OK.";
                            questionSub[h].appendChild(ok);
                        }else{
                            let ng = document.createElement("span");
                            ng.innerText = "NG.";
                            ng.style.color = "red";
                            questionSub[h].appendChild(ng);
                            myAnswer.style.color = "red";
                            myAnswer.style.backgroundColor =  "rgba(255, 1, 120, 0.2)";
                        }
                        
                }else{
                    clearTimeout(answered);
                    document.getElementById("reloadButton").style.display = "block";
                }
                h++;
                }, 500);
            }, 1000);
        }
    </script>
    <style>
        .errorMessage { color: red; background-color: rgba(255, 1, 120, 0.2); display: none; }
        .answerDisplay{ width: 60px; margin: 0px 20px; display: none; }
        .answerForm { width: 60px; }
        #timeLimitDisplay { width: 150px; height: 80px; position: absolute; top: 0; right: 0; background-color: #BBB; opacity: 0.6; display: none; }
        #timeLimitCount { font-size: 27px; color: #000; text-align: center; line-height: 80px; }
        #timeLimitUnit { font-size: 20px; color: #000; text-align: center; position: absolute; bottom: -20px; right: 5px; line-height: 80px; }
        #countDown { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; font-size: 50px; color: #FFF; text-align: center; background-color: #777; opacity: 0.7; line-height: 100vh; }
    </style>
</head>
<body>
    <h2>本日の計算 一旦完成、JS分割無しの直書き</h2>
    <section id="drillSection">
        <h3>問題</h3>
        <ul id="drillEntity">
            <li><span>Hoge</span><span>Hoge</span></li>
            <li>Fuga</li>
        </ul>

        <input type="button" id="reloadButton" value="もう一回" onclick="window.location.reload();" style="margin: 10px 5px; display: none;">
        <input type="button" id="endButton" value="終了" onclick="drillEnd();" style="display: none;">
    </section>
     <section>
        <input type="button" id="questionCreateButton" value="問題作成" onclick="checkSetting (document.getElementsByName('numberOfQuestions')[0].value, document.getElementsByName('minimumDigits')[0].value, document.getElementsByName('maxDigits')[0].value, document.getElementsByName('timeLimitInput')[0].value);">
         <h3>設定</h3>
         <p>使用する記号：
            <select id="useOperations" name="useOperations">
                <option value="＋">＋</option>
                <option value="－">－</option>
                <option value="✕">✕</option>
                <option value="÷">÷</option>
                <option value="＋,－">＋, －</option>
                <option value="＋,✕">＋, ✕</option>
                <option value="＋,÷">＋, ÷</option>
                <option value="－,✕">－, ✕</option>
                <option value="－,÷">－, ÷</option>
                <option value="✕,÷">✕, ÷</option>
                <option value="＋,－,✕">＋, －, ✕</option>
                <option value="＋,－,÷">＋, －, ÷</option>
                <option value="＋,✕,÷">＋, ✕, ÷</option>
                <option value="－,✕,÷">－, ✕, ÷</option>
                <option value="＋,－,✕,÷" selected>＋, －, ✕, ÷</option>
           </select>
        </p>
         <p>問題数：<input type="number" name="numberOfQuestions" size="10" style="width:70px;">　（最大100問）<span class="errorMessage" id="numberOfQuestionsNull">　※問題数が設定されていません</span><span class="errorMessage" id="numberOfQuestionsIllegal">　※問題数の入力値が不適切です</span></p>
         <p>最低桁数：<input type="number" name="minimumDigits" size="5" style="width:40px;">　（最低1桁）<span class="errorMessage" id="minimumDigitsNull">　※最低桁数が設定されていません</span><span class="errorMessage" id="minimumDigitsIllegal">　※最低桁数が不適切です</span><span class="errorMessage" id="minimumDigitsCompare">　※最低桁数が最大桁数よりも大きく設定されています</span></p>
         <p>最大桁数：<input type="number" name="maxDigits" size="5" style="width:40px;">　（最大4桁）<span class="errorMessage" id="maxDigitsNull">　※最大桁数が設定されていません</span><span class="errorMessage" id="maxDigitsIllegal">　※最大桁数が不適切です</span><span class="errorMessage" id="maxDigitsCompare">　※最大桁数が最低桁数よりも小さく設定されています</span></p>
         <p><input type="checkbox" name="timeLimitSetting" id="timeLimitSetting" value="1" onclick="formActive (this, document.getElementById('timeLimitInput')); formDisplay (this, document.getElementById('timeLimit'));">制限時間を設定する</p>
         <p id="timeLimit" style="display: none;">制限時間：<input type="number" id="timeLimitInput" name="timeLimitInput" size="5" style="width:50px;" disabled>秒<span class="errorMessage" id="timeLimitNull">　※制限時間が設定されていません</span></p>
     </section>

     <div id="timeLimitDisplay"><span id="timeLimitCount">0</span><span id="timeLimitUnit"> sec.</span></div>

     <div id="countDown">3</div>

</body>
</html>
